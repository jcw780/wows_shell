<!doctype html>
<html>

<meta charset="UTF-8">
<script src="https://unpkg.com/wasm-feature-detect/dist/umd/index.js"></script>
<script type="text/javascript" src="shellWasmV.js"></script>
<script type="text/javascript" src="shellWasm.wasm.js"></script>
<script>
    console.log('Started');
    let safe = false;
    let Module, instance;

    function testFull() {
        runFunc();
        runFuncSplit();
    }

    function instantiateVectorized(M) {
        console.log('Ready', M);
        Module = M;
        instance = new Module.shellCombined(2);
        console.log('Instance', instance);
        //testFull();
        //runFunc();
        runFuncSplit();
    }

    function instantiateStandard(M) {
        console.log('Ready', M);
        Module = M;
        instance = new Module.shellCombined(2);
        console.log('Instance', instance);
        //testFull();
        //runFunc();
        runFuncSplit();
    }

    if (typeof wasmFeatureDetect !== 'undefined') {
        wasmFeatureDetect.simd().then(simdSupported => {
            if (false) {
                console.log('vectorized');
                ShellWasmV().then(instantiateVectorized);
            } else {
                console.log('unvectorized');
                ShellWasm().then(instantiateStandard)
            }
        });
    } else {
        console.log('unvectorized');
        ShellWasm().then(instantiateStandard)
    }

    /*var Module = {
        onRuntimeInitialized: function () {

            runFunc();
            safe = true;
        }
    };*/
    //console.log(safe);
    function runFunc() {
        console.log('Entered');
        //instance = new M.shell(2);
        instance.setValues(.460, 780, .292, 1460, 2574, 6, .033, 76, 45, 60, 0, 0);
        instance.setValues(.220, 995, .2549, 207, 2574, 7, .022, 37, 55, 65, 0, 1);
        //console.log(instance);
        instance.calcImpact();
        //instance.printImpact();
        console.log("ran");
        var angles = [10];
        instance.calcAngles(70, -20);
        instance.calcPostPen(70, -20, angles, true, false);

        console.log("ran");
        //instance.printPostPen();
        //instance.delete();
        for (var num = 0; num < 2; num++) {
            for (var i = 0; i < instance.getImpactSize(); i++) {
                console.log(i, instance.getAnglePoint(i, Module.angleIndices.distance.value, num),
                    instance.getAnglePoint(i, Module.angleIndices.ra0.value, num)
                );
            }


            for (var i = 0; i < instance.getImpactSize(); i++) {
                //console.log(i);
                console.log(i, instance.getPostPenPoint(i, Module.postPenIndices.distance.value, 0, num),
                    instance.getPostPenPoint(i, Module.postPenIndices.x.value, 0, num),
                    instance.getPostPenPoint(i, Module.postPenIndices.xwf.value, 0, num)
                );
            }
        }

        instance.setValues(.460, 780, .292, 1460, 2574, 6, .033, 76, 45, 60, 0, 0);
        instance.setValues(.220, 995, .2549, 207, 2574, 7, .022, 37, 55, 65, 0, 1);
        instance.calcImpact();
        console.log("ran");
        instance.calcAngles(70, -20);
        instance.calcPostPen(70, -20, angles, true, false);

        console.log("ran");
        //instance.printPostPen();
        //instance.delete();
        for (var num = 0; num < 2; num++) {
            for (var i = 0; i < instance.getImpactSize(); i++) {
                console.log(i, instance.getAnglePoint(i, Module.angleIndices.distance.value, num),
                    instance.getAnglePoint(i, Module.angleIndices.ra0.value, num)
                );
            }


            for (var i = 0; i < instance.getImpactSize(); i++) {
                //console.log(i);
                console.log(i, instance.getPostPenPoint(i, Module.postPenIndices.distance.value, 0, num),
                    instance.getPostPenPoint(i, Module.postPenIndices.x.value, 0, num),
                    instance.getPostPenPoint(i, Module.postPenIndices.xwf.value, 0, num)
                );
            }
        }
    }
    const runFuncSplit = () => {
        const shellData = [
            [.460, 780, .292, 1460, 2574, 6, .033, 76, 45, 60, 0, ''],
            [.220, 995, .2549, 207, 2574, 7, .022, 37, 55, 65, 0, '']
        ];
        const angles = [10];
        const shells = [];
        const calc = new Module.shellCalc();
        for (const data of shellData) {
            shells.push(new Module.shell(...data));
        }

        for (const shell of shells) {
            calc.calcImpact(shell);
            calc.calcAngles(shell, 70, -20);
            calc.calcPostPen(shell, 70, -20, angles, true, false);
        }

        for (const shell of shells) {
            //testPoints(shell);
            testPointArrays(shell);
        }
    }

    const testPoints = (shell) => {
        let impactSize = shell.getImpactSize();
        let postpenSize = shell.getPostPenSize();
        for (let i = 0; i < impactSize; i++) {
            console.log(shell.getImpactPoint(i, Module.impactIndices.distance.value),
                shell.getImpactPoint(i, Module.impactIndices.rawPen.value));
        }
        console.log('done');

        for (let i = 0; i < impactSize; i++) {
            console.log(shell.getAnglePoint(i, Module.angleIndices.distance.value),
                shell.getAnglePoint(i, Module.angleIndices.ra0D.value));
        }
        console.log('done');

        for (let i = 0; i < postpenSize; i++) {
            console.log(shell.getPostPenPoint(i, Module.postPenIndices.distance.value, 0),
                shell.getPostPenPoint(i, Module.postPenIndices.x.value, 0),
                shell.getPostPenPoint(i, Module.postPenIndices.xwf.value, 0));
        }
        console.log('done');
    }

    const testPointArrays = (shell) => {
        console.log(shell.getimpactPointArray(
            Module.impactIndices.distance.value,
            Module.impactIndices.rawPen.value
        ));

        console.log(shell.getAnglePointArray(
            Module.angleIndices.distance.value,
            Module.angleIndices.ra0D.value
        ));

        console.log(shell.getPostPenPointArray(
            0,
            Module.postPenIndices.distance.value,
            Module.postPenIndices.x.value
        ));

        console.log(shell.getPostPenPointArrayFuseStatus(
            true, 0,
            Module.postPenIndices.distance.value,
            Module.postPenIndices.x.value
        ));

        console.log(shell.getPostPenPointArrayFuseStatus(
            false, 0,
            Module.postPenIndices.distance.value,
            Module.postPenIndices.x.value
        ));
    }

    if (safe) {
        //runFunc();
    }
    //}



</script>

<body>
    <button type="button" onclick="runFunc()">Test</button>
</body>

</html>